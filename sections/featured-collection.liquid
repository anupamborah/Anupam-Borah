<section id="featured-products-popup-{{ section.id }}" class="featured-products-section">
  <div class="page-width">
    {% if section.settings.title != blank %}
      <h2 class="section-title">{{ section.settings.title | escape }}</h2>
    {% endif %}

    <ul id="Grid-{{ section.id }}" class="product-grid">
      {% for i in (1..6) %}
        {% assign product_key = 'product_' | append: i %}
        {% assign product_handle = section.settings[product_key] %}
        {% assign product = all_products[product_handle] %}
        {% if product %}
          <li class="grid-item" data-product-handle="{{ product.handle }}" tabindex="0" role="button" aria-pressed="false">
            {% assign featured_image = product.featured_image | default: product.images.first %}
            <img 
              src="{{ featured_image | img_url: '400x400' }}" 
              alt="{{ product.title | escape }}" 
              loading="lazy" 
              style="width:100%; height:300px; object-fit: contain; cursor:pointer;" />
            <h3>{{ product.title }}</h3>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>

  <!-- Popup modal -->
  <div id="product-popup-{{ section.id }}" class="product-popup" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="popup-title-{{ section.id }}">
    <div class="popup-content" role="document">
      <button id="popup-close-{{ section.id }}" class="popup-close" aria-label="Close popup">&times;</button>

      <h2 id="popup-title-{{ section.id }}" class="popup-title"></h2>
      <p class="popup-price"></p>
      <div class="popup-description"></div>

      <form id="add-to-cart-form-{{ section.id }}">
        <div class="variant-options"></div>
        <button type="submit" class="add-to-cart-btn">Add to cart</button>
      </form>
      <p class="popup-message" aria-live="polite"></p>
    </div>
  </div>
</section>

<style>
  /* Grid and basic styles */
  .featured-products-section { padding: 40px 20px; }
  .featured-products-section .section-title { text-align: center; margin-bottom: 30px; font-size: 2rem; font-weight: bold; }
  #Grid-{{ section.id }} { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; list-style: none; padding: 0; margin: 0; }
  #Grid-{{ section.id }} .grid-item { cursor: pointer; }
  #Grid-{{ section.id }} .grid-item img { width: 100%; height: 300px; object-fit: contain; }
  #Grid-{{ section.id }} .grid-item h3 { margin-top: 8px; font-size: 1.2rem; }

  /* Popup styles */
  .product-popup {
    display: none;
    position: fixed;
    top: 0; left: 0; right:0; bottom:0;
    background: rgba(0,0,0,0.6);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }
  .product-popup.active {
    display: flex;
  }
  .popup-content {
    background:#fff;
    max-width: 500px;
    padding: 20px 30px;
    border-radius: 8px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }
  .popup-close {
    background: none;
    border: none;
    font-size: 30px;
    cursor: pointer;
    position: absolute;
    top: 8px;
    right: 10px;
  }
  .variant-options {
    margin: 20px 0;
  }
  .variant-options label {
    display: block;
    margin-bottom: 6px;
    font-weight: bold;
  }
  .variant-options select {
    width: 100%;
    padding: 8px;
    margin-bottom: 12px;
  }
  .add-to-cart-btn {
    background-color: #007bff;
    border: none;
    padding: 10px 16px;
    font-size: 1.1rem;
    color: white;
    cursor: pointer;
    border-radius: 4px;
  }
  .add-to-cart-btn:disabled {
    background-color: #999;
    cursor: not-allowed;
  }
  .popup-message {
    margin-top: 15px;
    font-weight: 600;
  }
</style>

<script>
  (() => {
    const sectionId = "{{ section.id }}";
    const productPopup = document.getElementById(`product-popup-${sectionId}`);
    const popupCloseBtn = document.getElementById(`popup-close-${sectionId}`);
    const popupTitle = productPopup.querySelector(".popup-title");
    const popupPrice = productPopup.querySelector(".popup-price");
    const popupDescription = productPopup.querySelector(".popup-description");
    const variantOptionsContainer = productPopup.querySelector(".variant-options");
    const addToCartForm = document.getElementById(`add-to-cart-form-${sectionId}`);
    const addToCartBtn = addToCartForm.querySelector(".add-to-cart-btn");
    const popupMessage = productPopup.querySelector(".popup-message");

    let currentProduct = null;
    let currentVariants = [];
    let selectedOptions = {};

    async function openPopup(productHandle) {
      try {
        const response = await fetch(`/products/${productHandle}.js`);
        if (!response.ok) throw new Error('Product data not found');
        currentProduct = await response.json();

        popupTitle.textContent = currentProduct.title;
        popupPrice.textContent = Shopify.formatMoney(currentProduct.price);
        popupDescription.innerHTML = currentProduct.description;

        currentVariants = currentProduct.variants;
        selectedOptions = {};

        variantOptionsContainer.innerHTML = "";
        currentProduct.options.forEach((optionName, index) => {
          const optionDiv = document.createElement("div");
          optionDiv.classList.add("variant-option");

          const label = document.createElement("label");
          label.textContent = optionName;
          label.htmlFor = `option-${index}-${sectionId}`;

          const select = document.createElement("select");
          select.id = `option-${index}-${sectionId}`;
          select.name = `option${index + 1}`;

          currentProduct.options_with_values[index].values.forEach(value => {
            const opt = document.createElement("option");
            opt.value = value;
            opt.text = value;
            select.appendChild(opt);
          });

          selectedOptions[optionName] = select.value;

          select.addEventListener("change", () => {
            selectedOptions[optionName] = select.value;
            updateSelectedVariant();
          });

          optionDiv.appendChild(label);
          optionDiv.appendChild(select);

          variantOptionsContainer.appendChild(optionDiv);
        });

        updateSelectedVariant();

        productPopup.classList.add("active");
        productPopup.setAttribute("aria-hidden", "false");
        addToCartBtn.disabled = false;
        popupMessage.textContent = "";

      } catch (error) {
        alert("Failed to load product details.");
        console.error(error);
      }
    }

    function updateSelectedVariant() {
      const found = currentVariants.find(variant => {
        return currentProduct.options.every((opt, idx) => variant[`option${idx + 1}`] === selectedOptions[opt])
      });
      if (found) {
        addToCartForm.dataset.variantId = found.id;
        popupPrice.textContent = Shopify.formatMoney(found.price);
        addToCartBtn.disabled = false;
      } else {
        popupPrice.textContent = "Unavailable";
        addToCartBtn.disabled = true;
        addToCartForm.dataset.variantId = null;
      }
    }

    async function addToCart(variantId) {
      if (!variantId) return;
      addToCartBtn.disabled = true;
      popupMessage.textContent = "Adding to cart...";
      try {
        const addMainResponse = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: variantId, quantity: 1 })
        });

        if (!addMainResponse.ok) throw new Error('Failed to add to cart');

        const hasBlack = Object.values(selectedOptions).some(val => val.toLowerCase() === 'black');
        const hasMedium = Object.values(selectedOptions).some(val => val.toLowerCase() === 'medium');

        if (hasBlack && hasMedium) {
          const swjResponse = await fetch('/products/soft-winter-jacket.js');
          if (swjResponse.ok) {
            const swjProduct = await swjResponse.json();
            const swjVariantId = swjProduct.variants[0].id;

            await fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: swjVariantId, quantity: 1 })
            });
          }
        }

        popupMessage.textContent = "Added to cart successfully!";
      } catch (err) {
        popupMessage.textContent = "Failed to add product to cart.";
        console.error(err);
      } finally {
        addToCartBtn.disabled = false;
      }
    }

    document.querySelectorAll(`#Grid-{{ section.id }} .grid-item`).forEach(item => {
      item.addEventListener('click', () => {
        const productHandle = item.dataset.productHandle;
        openPopup(productHandle);
      });
      item.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const productHandle = item.dataset.productHandle;
          openPopup(productHandle);
        }
      });
    });

    popupCloseBtn.addEventListener('click', () => {
      productPopup.classList.remove('active');
      productPopup.setAttribute('aria-hidden', 'true');
    });

    addToCartForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const variantId = addToCartForm.dataset.variantId;
      addToCart(variantId);
    });

    productPopup.addEventListener('click', function(e) {
      if(e.target === productPopup) {
        productPopup.classList.remove('active');
        productPopup.setAttribute('aria-hidden', 'true');
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Featured 6",
  "settings": [
    { "type": "text", "id": "title", "label": "Section title", "default": "Featured Products" },
    { "type": "product", "id": "product_1", "label": "Product 1" },
    { "type": "product", "id": "product_2", "label": "Product 2" },
    { "type": "product", "id": "product_3", "label": "Product 3" },
    { "type": "product", "id": "product_4", "label": "Product 4" },
    { "type": "product", "id": "product_5", "label": "Product 5" },
    { "type": "product", "id": "product_6", "label": "Product 6" }
  ],
  "presets": [{
    "name": "Featured 6 with Popup Cart",
    "category": "Products"
  }]
}
{% endschema %}
