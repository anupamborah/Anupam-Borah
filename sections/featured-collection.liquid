<section id="featured-products-addtocart-{{ section.id }}" class="featured-products-section">
  <div class="page-width">
    {% if section.settings.title != blank %}
      <h2 class="section-title">{{ section.settings.title | escape }}</h2>
    {% endif %}

    <ul id="Grid-{{ section.id }}" class="product-grid">
      {% for i in (1..6) %}
        {% assign product_key = 'product_' | append: i %}
        {% assign product_handle = section.settings[product_key] %}
        {% assign product = all_products[product_handle] %}
        {% if product %}
          {% assign featured_image = product.featured_image | default: product.images.first %}
          {% assign first_variant = product.variants.first %}
          <li class="grid-item" tabindex="0" role="button" aria-pressed="false">
            <img 
              src="{{ featured_image | img_url: '400x400' }}" 
              alt="{{ product.title | escape }}" 
              loading="lazy" 
              style="width:100%; height:300px; object-fit: contain;" />
            
            <button class="add-to-cart-btn" 
                    data-variant-id="{{ first_variant.id }}"
                    data-variant-options="{{ first_variant.option1 }}|{{ first_variant.option2 }}|{{ first_variant.option3 }}"
                    aria-label="Add {{ product.title }} to cart">
              Add to cart
            </button>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>
</section>

<style>
  .featured-products-section {
    padding: 40px 20px;
  }
  .section-title {
    text-align: center;
    margin-bottom: 30px;
    font-size: 2rem;
    font-weight: bold;
  }
  #Grid-{{ section.id }} {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .grid-item {
    text-align: center;
  }
  .grid-item img {
    width: 100%;
    height: 300px;
    object-fit: contain;
    border-radius: 4px;
    margin-bottom: 10px;
  }
  .add-to-cart-btn {
    background-color: #007bff;
    border: none;
    padding: 12px 16px;
    font-size: 1rem;
    color: white;
    cursor: pointer;
    border-radius: 6px;
    width: 100%;
  }
  .add-to-cart-btn:disabled {
    background-color: #999;
    cursor: not-allowed;
  }
</style>

<script>
  (function(){
    // Add to Cart button click handler - vanilla JS
    document.querySelectorAll('#Grid-{{ section.id }} .add-to-cart-btn').forEach(button => {
      button.addEventListener('click', async function(){
        const variantId = this.getAttribute('data-variant-id');
        const optionsStr = this.getAttribute('data-variant-options').toLowerCase(); // e.g. "black|medium|"
        this.disabled = true;
        try {
          // Add main product variant to cart
          const res = await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: variantId, quantity: 1 })
          });
          if (!res.ok) throw new Error('Add to cart failed');

          // Check options for Black & Medium for special add
          const hasBlack = optionsStr.includes('black');
          const hasMedium = optionsStr.includes('medium');

          if (hasBlack && hasMedium) {
            // Add 'Soft Winter Jacket' first variant automatically
            const swjResponse = await fetch('/products/soft-winter-jacket.js');
            if (swjResponse.ok) {
              const swjProduct = await swjResponse.json();
              const swjVariantId = swjProduct.variants[0].id;
              await fetch('/cart/add.js', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: swjVariantId, quantity: 1 })
              });
            }
          }
          alert('Added to cart successfully!');
        } catch (e) {
          alert('Failed to add to cart.');
          console.error(e);
        } finally {
          this.disabled = false;
        }
      });
    });
  })();
</script>

{% schema %}
{
  "name": "Featured 6 ",
  "settings": [
    { "type": "text", "id": "title", "label": "Section title", "default": "Featured Products" },
    { "type": "product", "id": "product_1", "label": "Product 1" },
    { "type": "product", "id": "product_2", "label": "Product 2" },
    { "type": "product", "id": "product_3", "label": "Product 3" },
    { "type": "product", "id": "product_4", "label": "Product 4" },
    { "type": "product", "id": "product_5", "label": "Product 5" },
    { "type": "product", "id": "product_6", "label": "Product 6" }
  ],
  "presets": [{
    "name": "Featured 6 Add To Cart Simple",
    "category": "Products"
  }]
}
{% endschema %}
